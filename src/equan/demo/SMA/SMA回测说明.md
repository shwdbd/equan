# SMA回测说明

SMA回测是根据示例程序写的第一个回测程序。

本次项目结束后，需要达成以下目的：

- 临摹完成SMA回测的程序；
- 完成简单的“选股、策略、交易、评估”的回测框架；
- 用tushare历史数据，对沪深300股票进行SMA回测；
- 时间控制在一周内完成，提高效率；



## 开发需求

### 临摹SMA需求

临摹视频教学中关于 烟蒂选股 和 SMA简单示例，使用类似的python代码进行实现，目的是程序可运行。

程序代码在 sma_demo.py 一个文件中实现。

本单元代码不需单元测试。



### 回测框架总需求

实现一个最简单的回测框架，基本由"选股"、“策略”、“交易”、“评估”四个子模块组成。选择分模块实现的目的是为了今后在这个模块上的扩展。

介绍各模块的分工和相互接口：

1. 选股模块。通过特定算法，找出最适合策略的股票代码清单。
   - 输入：无
   - 输出：股票代码列表
2. 策略模块。实现类似SMA的信号型结果策略。
   - 输入：单一股票价格日期序列
   - 输出：每日的仓位信号

3. 交易模块。根据执行交易的模块，计算收益、风险等每日数据。
   - 输入：选股模块传来的股票清单，策略模块来的每日仓位信号
   - 输出：交易明细，每日净值明细
4. 评估模块。回测结束后，计算总的收益、风险等评估数据。
   - 输入：交易模块的输出
   - 输出：股票收益、策略收益、最大回测、交易成本等

### 选股模块

采用烟蒂策略，即分行业找PE、PB最小的股票。考虑到高流通性，选择范围从沪深300范围内选择。

本阶段选股有两个策略选择：

策略一：选择各行业中 PE*PB 最小的三个股票；

策略二：根据经验值挑选。经验数值如下：

|      | 大盘股 |      | 中盘股 |      | 小盘股 |      |
| ---- | ------ | ---- | ------ | ---- | ------ | ---- |
| PE   | <0.7   | <0.8 | <0.8   | <50  | <0.9   | <50  |
| PB   | <30    | <6   | <1     | <10  | <1     | <20  |

其中：

- 大盘股，总市值 >500亿元
- 中盘股，100亿元 <= 总市值 <= 500亿元 
- 小盘股，总市值 < 100亿元



### 策略模块

策略模块从选股清单中逐一选择股票，然后使用SMA移动平均线的策略进行处理，并将每日的仓位（position）给到交易模块进行交易。

策略模块需要实现以下功能：

- 使用20日移动平均线（SMA20）和60日移动平均线（SMA60）进行计算；
- 如果SMA20上穿SMA60，则仓位=买入；
- 如果SMA60下穿SMA60，则仓位=卖出；
- 如果SMA60等于SMA60，则仓位不变；
- 股票持有期：1天； 



### 交易模块

交易模块接收策略模块发来的日仓位序列，按日进行交易。

支持的功能有：

- 账户净值计算；
- 按close价格进行交易；
- 涨跌停停止交易；
- 结果输出，交易日清单.csv
- 【可选】账户余额控制，账户有初始金额



### 评估模块

根据交易模块生成的交易日清单，汇总统计各类策略。

- 股票总收益（连续、离散）
- 策略总收益
- 最大回撤
- 开仓次数（Long、Short分开汇总）
- ShapeRatio



## 程序设计

### 总体程序结构

如下：

- 总包：equan.demo.sma
- 使用CLI命令行进行操作，命令入口 sma.py
- sma_impl 记录的是实际实现的代码, sma_tool 是工具类代码
- 单元测试：equan_test.demo.sma.test_sma.py
- 总框架类：equan.demo.SMA.sma.EquityTradingStrategyFrame
- 实现类：sma_impl.SMATestFrame
- 各模块的接口：
  - 选股模块:   seek_equity(): list
  - 策略模块：
    - 接口类：Strategy：run(equity_code):df有日期和仓位
    - SMA实现：SMAStrategy
  - 交易模块：
    - Trading
    - run_test(equity_pool, strategy_impl):trading_log_df   交易运行函数
  - 评估模块：
    - evaluate(trading_log_df, out_file) 统计后将结果输出到文件



### 选股模块设计

- 能实现两种模式的选股，即PE*PB最小法 和 经验区间法
- 基准日期作为参数
- 用哪个股票池也做为参数，默认为沪深300
- 执行逻辑：

  - 取得hs300

  - 数据清理（空值等）

  - 如果是 PEPB 模式

    - 计算PE、PB
    - 分类统计，按行业选择最N的三个股票

  - 如果是矩阵模式

    - 按矩阵找出符合条件的股票
    - 按行业区分，如果太多则只取前3
- 单元测试：模拟10个股票，然后进行选择，看看能不能把期望的股票选出来
- 程序优化：



### 策略模块设计

程序如下：

- 通用策略接口: EquityTradingStrategyFrame.strategy
  - 具体的实现类要继承这个接口，并实现
- SMA的实现：
  - 计算 SMA_ShortTerm, SMA_LongTerm
  - 然后当 





### 交易模块设计



### 评估模块设计













## 开发计划

本项目周期从周二正式开始到周五下班前结束，共4个工作日。

预留周四为测试与发布时间，实际开发时间只有三天。

DAY1：完成需求编制，完成Demo，完成交易模块的设计；

DAY2：完成策略模块、选股模块的开发与单元测试；

DAY3：完成交易模块、评估模块的开发与单元测试。

本项目在 github 上的项目编号为：SMA Demo















